"use strict";function UsersCtrl(){EventEmitter.call(this)}var path=require("path"),EventEmitter=require("events"),config=require(path.resolve("./config/config")),sequelize=require(path.resolve("./config/lib/sequelize")),session=require("express-session"),SequelizeStore=require("express-sequelize-session")(session.Store),logger=require(path.resolve("./config/lib/logger")).getLogger_FileNameBase(__filename);UsersCtrl.prototype=Object.create(EventEmitter.prototype);var usersCtrl=module.exports=new UsersCtrl;usersCtrl.USERRELOGIN="USERRELOGIN",usersCtrl.store=new SequelizeStore(sequelize,config.sessionTable,null,config.sessionLogging?null:{logging:!1}),usersCtrl.userSession={},usersCtrl.getUserId=function(e){return"object"==typeof e&&(e=e.id),e},usersCtrl.getUserName=function(e){return"object"==typeof e&&(e=e.username),e},usersCtrl.userSessionCheck=function(e,r){var s=this.getUserId(e),o=this;return new Promise(function(t,n){if("number"!=typeof s)return logger.error("userSessionCheck error user param:",s),n(new Error("userSessionCheck error user param:"+s));var i=o.userSession[s];if(i)return i===r?t(!1):(logger.warn("user id:%s,name:%s sessionID %s has prev sessionID %s, prev session destroy",s,e.username,r,i),o.store.destroy(i).then(function(){return o.emit(o.USERRELOGIN,e),t(!0)}));t(!0)}).then(function(t){t&&(o.userSession[s]=r,logger.info("user %s(%s) session saved.",o.getUserName(e),s))}).catch(function(o){logger.error("userSessionCheck user id:%s,name:%s, sessionID %s error:",s,e.username,r,o)})},usersCtrl.userSessionClear=function(e){var r=this.getUserId(e);logger.info("user %s(%s) session clear.",this.getUserName(e),r),"number"!=typeof r?logger.error("userSessionClear error user param"):delete this.userSession[r]};