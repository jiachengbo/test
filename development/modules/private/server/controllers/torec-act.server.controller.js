"use strict";function getCanRecvFiles(e){switch(e){case RECACT.RECORD:return[{name:"create_photo"},{name:"check_photo"},{name:"handle_photo"}];case RECACT.VERIFYRET:return[{name:"verify_photo"}];case RECACT.CHECKRET:return[{name:"check_photo"}];case RECACT.HANDLERET:return[{name:"handle_photo"}];case RECACT.ACCEPT:case RECACT.REGISTER:case RECACT.AUTOFH:case RECACT.VERIFYDISPATCH:case RECACT.HANDLEDISPATCH:case RECACT.TRANSFER:case RECACT.CHECKDISPATCH:case RECACT.SUPERINTEND:case RECACT.CLOSE:case RECACT.DISCARD:case RECACT.PRIREC:return[];default:return logger.error("getCanRecvFiles act "+e+" not defined"),null}}function getStateCanActs(e,t){var r=[];switch(e){case RECSTATES.INIT:var a;a=t.roles.includes("xxxx")?RECSTATES.VERIFIED:RECSTATES.WAITACCEPT,r[RECACT.RECORD]=a;break;case RECSTATES.WAITACCEPT:r[RECACT.VERIFYDISPATCH]=RECSTATES.WAITVERIFY;break;case RECSTATES.WAITVERIFY:r[RECACT.VERIFYRET]=RECSTATES.VERIFIED;break;case RECSTATES.VERIFIED:r[RECACT.ACCEPT]=RECSTATES.ACCEPTED,r[RECACT.VERIFYDISPATCH]=RECSTATES.WAITVERIFY;break;case RECSTATES.ACCEPTED:r[RECACT.REGISTER]=RECSTATES.WAITCONTROL,r[RECACT.AUTOFH]=RECSTATES.CLOSED,r[RECACT.CLOSE]=RECSTATES.CLOSED,r[RECACT.DISCARD]=RECSTATES.CLOSED;break;case RECSTATES.WAITCONTROL:r[RECACT.HANDLEDISPATCH]=RECSTATES.WAITHANDLE,r[RECACT.TRANSFER]=RECSTATES.WAITSUPERVISE;break;case RECSTATES.WAITHANDLE:r[RECACT.HANDLERET]=RECSTATES.HANDLED;break;case RECSTATES.HANDLED:r[RECACT.TRANSFER]=RECSTATES.WAITSUPERVISE,r[RECACT.HANDLEDISPATCH]=RECSTATES.WAITHANDLE;break;case RECSTATES.WAITSUPERVISE:r[RECACT.CHECKDISPATCH]=RECSTATES.WAITCHECK,r[RECACT.TRANSFER]=RECSTATES.WAITCONTROL;break;case RECSTATES.WAITCHECK:r[RECACT.CHECKRET]=RECSTATES.CHECKED;break;case RECSTATES.CHECKED:r[RECACT.CLOSE]=RECSTATES.CLOSED,r[RECACT.DISCARD]=RECSTATES.CLOSED,r[RECACT.TRANSFER]=RECSTATES.WAITCONTROL;break;case RECSTATES.CLOSE:break;default:return logger.error("getStateCanActs no state %d defined",e),null}return e!==RECSTATES.INIT&&e!==RECSTATES.CLOSE&&(r[RECACT.SUPERINTEND]=e,r[RECACT.PRIREC]=e),r}function getNextState(e,t,r){var a=getStateCanActs(e,r);if(!a||void 0===a[t.act_id])return logger.error("getNextState=>getStateCanActs state %d can run actid %d",e,t.act_id),null;var c=a[t.act_id];if("number"==typeof c)return c;var E=c[t.act_result];return"number"!=typeof E?(logger.error("getNextState actNext %s, actresult %d error",c,t.act_result),null):E}var path=require("path"),multer=require(path.resolve("./config/private/multer")),putils=require(path.resolve("./config/private/utils")),constVALUES=require(path.resolve("./modules/global/server/config/const.server.config")),logger=require(path.resolve("./config/lib/logger")).getLogger_FileNameBase(__filename);const RECSTATES=constVALUES.RECSTATES,RECACT=constVALUES.RECACT;var whiteTorecFields=[{name:"address",required:!0},{name:"communityid",required:!0},{name:"districtid",required:!0},{name:"eventdesc",required:!0},{name:"eventsrcid",required:!0},{name:"eventtypeid",required:!0},{name:"maintypeid",required:!0},{name:"subtypeid",required:!0},{name:"rectypeid",required:!0},{name:"streetid",required:!0},{name:"timeareaid",required:!0},{name:"cellid",required:!0},{name:"coordinatex",required:!0},{name:"coordinatey",required:!0}],whiteTocallrecordFields=[{name:"calltypeid",required:!0},{name:"telcall",required:!0},{name:"calltime",required:!1},{name:"returnvisitflag",required:!1,default:""},{name:"returnvisitphone",required:!1,default:""},{name:"name",required:!1,default:""},{name:"address",required:!1,default:""},{name:"sex",required:!1,default:""}],whiteNormalFields=[{name:"act_id",required:!0},{name:"act_content",required:!1,default:""},{name:"act_remark",required:!1,default:""},{name:"act_recvuserid",required:!1,default:""},{name:"act_result",required:!1,default:1},{name:"act_photo",required:!1,default:""}],uploadImage=new multer("torec",10485760,/image/,".jpg");uploadImage.mkPaths();var allRecvFiles=[{name:"create_photo"},{name:"check_photo"},{name:"verify_photo"},{name:"handle_photo"}];exports.ctrlAct=function(e,t,r){var a,c=new Date,E=e.user,C={};return a=r?r.state_id:RECSTATES.INIT,new Promise(function(r,a){t?uploadImage.recv(e,t,allRecvFiles).then(r):r({})}).then(function(t){if(a===RECSTATES.INIT)C.act={act_id:RECACT.RECORD,act_note:"添加新记录",act_remark:"",act_result:1};else{if(!e.body||!e.body.act)throw logger.error("torec ctrlAct body or body.act not valid"),new Error("服务器校验错误，请求参数没有或动作内容没有："+JSON.stringify(e.body));if(C.act=putils.checkFields(whiteNormalFields,e.body.act),!C.act||"string"==typeof C.act)throw logger.error("torec get act no column error:",C.act),new Error("服务器校验错误，没有规定的动作记录字段"+C.act);var r=Number(C.act.act_id);if(isNaN(r))throw logger.error("torec get act column id error:",C.act.act_id),new Error("服务器校验错误，动作id"+C.act.act_id);C.act.act_id=r;var c=Number(C.act.act_result);if(isNaN(c))throw logger.error("torec get act column id error:",C.act.act_result),new Error("服务器校验错误，动作id"+C.act.act_result);C.act.act_result=c}var E=getCanRecvFiles(C.act.act_id);if(!E)throw new Error("create/update no act "+C.act.act_id+" defined");for(var i in t){for(var T=0;T<E.length&&E[T].name!==i;T++);T<E.length&&Array.isArray(t[i])&&t[i].length>0&&(logger.debug("recv field %s,file %s",i,t[i][0].filename),C.act.act_photo=C[i]=path.join(uploadImage.mountDir,t[i][0].filename).replace(/\\/g,"/"))}}).then(function(){if(C.state_id=getNextState(a,C.act,E),!C.state_id)throw new Error("torec oldstate "+a+" act "+C.act.act_id+" getNextState return error");switch(C.act.act_id){case RECACT.RECORD:var t=putils.checkFields(whiteTorecFields,e.body);if(!t||"string"==typeof t)throw logger.error("torec register no column error:",t),new Error("服务器校验错误，没有规定案件记录字段"+t);if(Object.assign(C,t),e.body.crd){var r=putils.checkFields(whiteTocallrecordFields,e.body.crd);if(!r||"string"==typeof r)throw logger.error("tocallrecord register no column error:",r),new Error("服务器校验错误，没有规定呼叫记录字段"+r);C.crd=r}C.create_time=c,C.create_userid=E.id,C.state_id===RECSTATES.VERIFIED&&(C.accept_userid=C.create_userid,C.accept_time=C.create_time);break;case RECACT.SUPERINTEND:C.urgentflag=C.act.act_result;break;case RECACT.PRIREC:C.priflag=C.act.act_result;break;case RECACT.ACCEPT:C.accept_userid=E.id,C.accept_time=c;break;case RECACT.REGISTER:C.register_userid=E.id,C.register_time=c;break;case RECACT.VERIFYRET:C.verify_photo=C.act.act_photo;break;case RECACT.CHECKRET:C.check_photo=C.act.act_photo;break;case RECACT.HANDLERET:C.handle_photo=C.act.act_photo}return C}).then(function(e){if(void 0===typeof e)throw new Error("torec act "+C.act.act_id+"no return valid value");return Object.assign(C.act,{act_userid:E.id,act_time:c,old_state_id:a,new_state_id:C.state_id}),C.state_id===RECSTATES.CLOSED&&Object.assign(C,{close_time:c,close_userid:E.id,close_content:C.act.act_content}),Object.assign(C,{lastact_actid:C.act.act_id,lastact_userid:C.act.act_userid,lastact_time:C.act.act_time,lastact_content:C.act.act_content+"("+C.act.act_remark+")",lastact_recvuserid:C.act.act_recvuserid}),C})},exports.getStateCanActs=getStateCanActs;