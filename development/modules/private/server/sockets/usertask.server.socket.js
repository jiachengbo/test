"use strict";function UserTask(e,r){putils.GroupData.apply(this),this.mhCfgList=e,r&&"string"==typeof r||(r="userTask"),this.logger=require(path.resolve("./config/lib/logger")).getLogger(r)}var path=require("path"),putils=require(path.resolve("./config/private/utils")),RESULT=require(path.resolve("./modules/private/server/sockets/const.server.socket")).RESULT,sequelize=require(path.resolve("./config/lib/sequelize")),CommTaskM=sequelize.model("CommTask");UserTask.prototype=Object.create(putils.GroupData.prototype),module.exports=UserTask,UserTask.prototype._addTask=function(e,r){if(this.isValidUser(e)){var t=putils.getObjId(e),s=this.add(t,r);return 1===this.getGroup(t).length&&this._startSendTask(e,100),s}return 0},UserTask.prototype._getUserObj=function(e){var r=this.getGroup(putils.getObjId(e));return r?r.user:null},UserTask.prototype._getNextRunRec=function(e){var r=this.getGroup(putils.getObjId(e));return!r||r.length<1?null:r.runRec?null:(r.runRec=r.shift(),r.runRec)},UserTask.prototype._clearRunRec=function(e){var r=this.getGroup(putils.getObjId(e));return r&&r.runRec?(delete r.runRec,1):0},UserTask.prototype._startSendTask=function(e,r){if(!this.isValidUser(e))return void this.logger.error("startsendtask user %s not valid",putils.getObjId(e,"username"));setTimeout(this._runSendTask.bind(this),r,e)},UserTask.prototype._runSendTask=function(e){if("object"!=typeof e){var r=this._getUserObj(e);"object"==typeof r&&(e=r)}var t=this.getUserSocket(e);if(!t)return void this.logger.warn("runSendTask user %s no valid socket",putils.getObjId(e,"username"));var s=this._getNextRunRec(e);if(s){var n=this.mhCfgList.getCommand(s.msgcode);if(!n)return this.logger.error("runSendTask user %s commTask.id %d commTask.msgcode %s no command error",putils.getObjId(e,"username"),s.id,s.msgcode),void this._clearRunRec(e);var o=this,i=new n(t,s);return this.logger.info("runSendTask user %s commTask.msgcode %s",putils.getObjId(e,"username"),s.msgcode),i.run().then(function(e){return s.update(e)}).then(function(){o.logger.info("runSendTask user %s commTask.msgcode %s result %d",putils.getObjId(e,"username"),s.msgcode,s.result),o._clearRunRec(e),setTimeout(o._runSendTask.bind(o),100,e)}).catch(function(r){o.logger.error("runSendTask user %s commTask.msgcode %s error:",putils.getObjId(e,"username"),s.msgcode,r),o._clearRunRec(e),setTimeout(o._runSendTask.bind(o),100,e)})}},UserTask.prototype._runRecvTask=function(e){var r=this.getUserSocket(e);if(!r)return void this.logger.warn("_runRecvTask user %s no valid socket",putils.getObjId(e,"username"));var t=this,s=this.getGroup(putils.getObjId(e)),n=s.reqList=[];this.mhCfgList.getReqMsgCfgs().forEach(function(s){var o=new s.request(r,s.msgcode,s.options);n.push(o),o.on(o.REQEND,function(r){t.logger.info("_runRecvTask recv user %s request %s run goodend",putils.getObjId(e,"username"),s.msgcode),t.insertRecvRec(e,s,r)}),o.on(o.REQERROR,function(r){t.logger.error("_runRecvTask recv user %s request run errorend:",putils.getObjId(e,"username"),r),r||t.insertRecvRec(e,s,r)}),o.listen(o.recvRequestCallBack)})},UserTask.prototype.callRecvRequest=function(e,r){var t=putils.getObjId(e),s=this.getGroup(t);if(!s)throw new Error("not find user:"+e);var n,o,i=s.reqList;for(o=0;o<i.length&&(n=i[o],n.msgcode!==r.msgcode);o++);if(o>=i.length)throw new Error("not find recvTask:"+r.msgcode);n.recvRequestCallBack.apply(n,Array.prototype.slice.call(arguments,2))},UserTask.prototype.insertSendRec=function(e,r,t,s){var n=Object.assign({user:String(putils.getObjId(e)),first_time:new Date,msgcode:r.msgcode,msgarg:r.options,msgsend:t,reqid:null,attempttimes:0,result:0},"object"==typeof s?s:{});return CommTaskM.create(n)},UserTask.prototype.insertRecvRec=function(e,r,t){var s=Object.assign({user:String(putils.getObjId(e)),msgcode:r.msgcode,msgarg:r.options},t);return CommTaskM.create(s)},UserTask.prototype._loadSendTasks=function(e){var r=this,t=putils.getObjId(e),s=JSON.stringify({loss:!0});return s=s.substring(1,s.length-1),CommTaskM.update({result:RESULT.LOSSSCLEAR},{where:{user:String(t),result:RESULT.NOCOMPLETE,reqid:null,msgarg:{$like:"%"+s+"%"}}}).then(function(e){return CommTaskM.findAll({where:{user:String(t),result:RESULT.NOCOMPLETE,reqid:null,first_time:{$gt:new Date(Date.now()-2592e6)}},order:"id ASC"})}).then(function(s){return s.length>0&&(s.forEach(function(e){r.add(t,e)}),r._startSendTask(e,5e3)),r.logger.info("user %s loadsendtasks %d records",putils.getObjId(e,"username"),s.length),s})},UserTask.prototype.runTask=function(e,r){this.initUser(e,r);var t=this;return this._loadSendTasks(e).then(function(){return t._runRecvTask(e)}).catch(function(e){t.logger.error("runtask error:",e)})},UserTask.prototype.addSendRecs=function(e,r,t,s){if(!r||!r.command){var n="addrectasks msghandlecfg not valid command error";return this.logger.error(n),Promise.reject(new Error(n))}Array.isArray(e)||(e=[e]);var o=this,i=[];return e.forEach(function(e){i.push(o.insertSendRec(e,r,t,s))}),Promise.all(i).then(function(r){for(var t=0;t<e.length;t++)o._addTask(e[t],r[t])})},UserTask.prototype.getUserSocket=function(e){var r=this.getGroup(putils.getObjId(e));return r?r.socket:null},UserTask.prototype.initUser=function(e,r){var t=putils.getObjId(e),s=this.getGroup(t);s&&this.clearUser(e),s=[],s.user=e,s.socket=r,s.reqList=null,s.runRec=null,this.setGroup(t,s)},UserTask.prototype.isValidUser=function(e){var r=putils.getObjId(e);return!!this.getGroup(r)},UserTask.prototype.clearUser=function(e){var r=putils.getObjId(e),t=this.getGroup(r);if(t)return t.reqList&&(t.reqList.forEach(function(e){e.stopListen(),e.removeAllListeners()}),delete t.reqList),delete t.user,delete t.socket,delete t.runRec,this.removeGroup(r)};